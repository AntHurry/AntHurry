<!DOCTYPE html>
<html data-theme="light" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">

<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <!--    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.6/dist/full.css" rel="stylesheet" type="text/css" />-->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@3.1.0/dist/full.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/87140d707c.js" crossorigin="anonymous"></script>
  <!-- toastr 불러오기 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
  <link rel="stylesheet" href="https://jhs512.github.io/toastr/toastr.css">

  <script src="/resource/common/common.js"></script>
  <link href="/resource/common/common.css" rel="stylesheet">
</head>

<body class="w-screen">

<main layout:fragment="main">
  <section class="navbar bg-base-100">
    <div class="navbar-start">
      <div class="dropdown">
        <label tabindex="0" class="btn btn-ghost btn-circle">
          <i class="fa-solid fa-bars"></i>
        </label>
        <ul tabindex="0" class="menu menu-compact dropdown-content mt-3 p-2 shadow bg-base-100 rounded-box w-64">
          <li>
            <a th:href="@{/}">
              <span>메인</span>
            </a>
          </li>
          <li th:if="${@rq.logout}">
            <a th:href="@{|/usr/member/login|}">
              <span>로그인</span>
            </a>
          </li>
          <li th:if="${@rq.login}">
            <a href="javascript:" onclick="$(this).next().submit();">
              <span>로그아웃</span>
            </a>
            <form class="!hidden" hidden th:action="|/usr/member/logout|" method="POST"></form>
          </li>
        </ul>
      </div>
    </div>
    <div class="navbar-center">
      <a class="font-black">프로필 페이지</a>
    </div>
    <div class="navbar-end">
      <button class="btn btn-ghost btn-circle">
        <i class="fa-solid fa-ellipsis-vertical"></i>
      </button>
    </div>
  </section>

  <div class="flex-grow flex justify-center align-center">
    <form id="profileUpdateForm" class="flex flex-col">
      <div class="input-group mt-3">
        <label for="phoneNumber">전화번호</label>
        <input type="tel" id="phoneNumber" name="phoneNumber" value="" class="mx-1"placeholder="전화번호를 입력해주세요." />
        <button type="button" id="phoneAuthButton">인증번호 전송</button>
      </div>
      <div class="input-group mt-3">
        <label for="checkNumber">인증번호</label>
        <input type="tel" id="checkNumber" name="checkNumber" value="" class="mx-1"placeholder="인증번호를 입력해주세요." />
        <button type="button" id="checkAuthCode">인증번호 확인</button>
      </div>
      <div id="timerDisplay" class="flex-center">03:00</div>
      <button type="button" class="mt-3" id="certBtn" value="인증완료">인증완료</button>
    </form>
  </div>
</main>

<div th:replace="~{common/navbar :: navbar}"></div>

<script th:inline="javascript">
  // 타임리프 문법(파라미터, ? 뒤에 입력된 매개변수들)
  const params = /*[[ ${param} ]]*/ null;

  if (params.msg) {
    toastNotice(params.msg[0]);
  }

  if (params.errorMsg) {
    toastWarning(params.errorMsg[0]);
  }

  // history.back 에 의해서 돌아온 경우에 실행됨
  // 평소에도 실행됨
  $(window).bind("pageshow", function (event) {
    const localStorageKeyAboutHistoryBackErrorMsg = "historyBackErrorMsg___" + location.href;

    if (localStorage.getItem(localStorageKeyAboutHistoryBackErrorMsg)) {
      toastWarning(localStorage.getItem(localStorageKeyAboutHistoryBackErrorMsg));
      localStorage.removeItem(localStorageKeyAboutHistoryBackErrorMsg);
    }
  });
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {
    //CSRF
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");

    //타이머
    var interval = null;

    $(document).ajaxSend(function(e, xhr, options) {
      xhr.setRequestHeader(header, token);
    });

    //인증번호 전송
    $('#phoneAuthButton').on('click', function(e) {
      e.preventDefault();

      var phoneNumber = $("#phoneNumber").val();

      $.ajax({
        url: '/usr/member/phoneAuth/send',
        type: 'POST',
        data: {
          phoneNumber: phoneNumber
        },
        success: function(data) {
          // 요청이 성공적으로 완료되면 이곳에 코드를 작성합니다.
          alert("인증번호가 발송되었습니다.");
          var timeLeft = 180; // 초 단위

          // 타이머를 표시할 요소를 선택
          var displayElement = document.getElementById("timerDisplay");

          // 이전 타이머가 있다면 종료
          if (interval) {
            clearInterval(interval);
          }

          // 타이머 시작 (1초마다 타이머 업데이트)
          interval = setInterval(function () {
            timeLeft--;

            var minutes = Math.floor(timeLeft / 60);
            var seconds = timeLeft % 60;

            // 타이머 값을 업데이트
            displayElement.textContent =
                    (minutes < 10 ? "0" : "") +
                    minutes +
                    ":" +
                    (seconds < 10 ? "0" : "") +
                    seconds;
            // 시간이 끝났으면 타이머 중지
            if (timeLeft <= 0) {
              clearInterval(interval);
              alert("인증시간이 지났습니다. 인증번호를 다시 받아주세요.");
            }
          }, 1000); // 1초에 한 번씩 실행
        },
        error: function(jqXHR, textStatus, errorThrown) {
          // 요청이 실패하면 이곳에 코드를 작성합니다.
          alert('핸드폰 인증에 실패하였습니다. 다시 시도해 주세요.');
        }
      });
    });

    //인증번호 검증
    $("#checkAuthCode").click(function () {
      var phoneNumber = $("#phoneNumber").val();
      var checkNumber = $("#checkNumber").val();

      $.ajax({
        url: '/usr/member/phoneAuth/check',
        type: 'POST',
        data: {
          phoneNumber: phoneNumber,
          authCode: checkNumber
        },
        success: function (response) {
          clearInterval(interval); //타이머 중지
          alert(response);
        },
        error: function(jqXHR, textStatus, errorThrown) {
          // 서버가 반환한 데이터를 확인합니다.
          alert(jqXHR.responseText);
        }
      });
    });

    $("#certBtn").click(function(e) {
      var phoneNumber = $("#phoneNumber").val();

      $.ajax({
        url: '/usr/member/phoneAuth',
        type: 'POST',
        data: {
          phoneNumber: phoneNumber
        },
        success: function (response) {
          if(response === "전화번호 인증이 완료되었습니다.")
            window.location.href = "/";
          alert(response);
        },
        error: function(jqXHR, textStatus, errorThrown) {
          // 서버가 반환한 데이터를 확인합니다.
          alert(jqXHR.responseText);
        }
      });
    });


  });
</script>

</body>

</html>