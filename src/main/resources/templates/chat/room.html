<html layout:decorate="~{usr/layout/layout.html}">

<head>
    <title th:text="|${otherMember.getUsername()} 님과의 채팅|"></title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<header layout:fragment="header" class="sticky top-0 z-50">
    <div class="navbar max-w-2xl mx-auto bg-base-100">
        <div class="navbar-start">
            <div>
                <a tabIndex="0" class="btn btn-ghost btn-circle" onClick="history.back()">
                    <i class="fa-solid fa-angle-left"></i>
                </a>
            </div>
        </div>
        <div class="navbar-center">
            <a class="font-black" th:text="|${otherMember.getUsername()} 님과의 채팅|"></a>
        </div>
        <div class="navbar-end">
            <label for="my_modal_7" class="btn btn-ghost btn-circle">
                <i class="fa-solid fa-ellipsis-vertical"></i>
            </label>
            <input type="checkbox" id="my_modal_7" class="modal-toggle"/>
            <div class="modal">
                <div class="modal-box">
                    <a th:if="${room.tradeStatus.status.msg.equals('거래 전')}" class="btn btn-ghost block pt-4"
                       th:href="@{/trade/start/{id}(id=${room.tradeStatus.id})}">거래 시작</a>
                    <a th:if="${room.tradeStatus.status.msg.equals('거래 중')}" class="btn btn-ghost block pt-4"
                       th:href="@{/trade/complete/{id}(id=${room.tradeStatus.id})}">거래 완료</a>
                    <hr>
                    <a th:href="@{/chat/exit/{id}(id=${room.id})}" class="btn btn-ghost block pt-4">채팅방 나가기</a>
                </div>
                <label class="modal-backdrop" for="my_modal_7">Close</label>
            </div>
        </div>
    </div>
</header>

<main layout:fragment="main" class="flex-grow flex items-center justify-center w-screen h-[1000px] p-8">
    <div id="chat-area" class="flex flex-col w-[650px] h-full">
        <div id="messages" class="flex text-center w-full justify-end" th:each="message : ${chatMessages}">
            <div class="chat chat-start" th:if="${!@rq.getMember().getNickname().equals(message.writer)}">
                <div class="chat-image avatar">
                    <div class="w-10 rounded-full bg-pink-400"></div>
                </div>
                <div class="chat-header">
                    <time class="text-xs opacity-50" th:text="${#temporals.format(message.createdAt, 'HH:mm')}"></time>
                </div>
                <div class="chat-bubble" th:text="${message.message}"></div>
            </div>
            <div class="chat chat-end flex justify-end" th:if="${@rq.getMember().getNickname().equals(message.writer)}">
                <div class="chat-header">
                    <time class="text-xs opacity-50" th:text="${#temporals.format(message.createdAt, 'HH:mm')}"></time>
                </div>
                <div class="chat-bubble" th:text="${message.message}"></div>
                <div class="chat-image avatar">
                    <div class="w-10 rounded-full bg-pink-400"></div>
                </div>
            </div>
        </div>
        <div id="input-area" class="flex order-1 justify-center mt-auto mb-12">
            <input id="send-msg" type="text" class="input input-bordered w-full max-w-sm"/>
            <button id="send-button" class="btn btn-outline"><i class="fa-regular fa-paper-plane"></i></button>
            <button class="btn" onclick="my_modal_1.showModal()"><i class="fa-solid fa-paperclip"></i></button>
            <dialog id="my_modal_1" class="modal">
                <form method="dialog" class="modal-box">
                    <input type="file" class="file-input file-input-bordered file-input-sm w-full max-w-sm" />
                    <div class="modal-action">
                        <a class="btn" th:href="@{/chat/room/file/{id}(id=${room.id})}">보내기</a>
                        <button class="btn">닫기</button>
                    </div>
                </form>
            </dialog>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script th:inline="javascript">
        $(document).ready(function () {
            var sockJs = new SockJS("/ws/chat");
            var stomp = Stomp.over(sockJs);

            var roomId = [[${room.id}]];
            var username = [[${@rq.member.nickname}]];

            stomp.connect({}, function () {
                stomp.subscribe("/sub/chat/room/" + roomId, function (message) {
                    var content = JSON.parse(message.body);
                    var writer = content.writer;

                    var msg = document.createElement("div");
                    msg.className = writer === username ? "chat chat-end" : "chat chat-start";
                    msg.innerHTML = "<div class='chat-image avatar'><div class='w-10 rounded-full bg-pink-400'></div></div>" +
                        "<div class='chat-header'>" +
                        "<time class='text-xs opacity-50' th:utext='${#temporals.format(message.getCreatedAt(), 'HH:mm')}'></time>" +
                        "</div>" +
                        "<div class='chat-bubble'>" + content.message + "</div>";

                    $("#chat-area").append(msg);
                    $("#chat-area").scrollTop($("#chat-area")[0].scrollHeight);
                });

                if (msg.value != null) {
                    stomp.send('/pub/chat/message', {}, JSON.stringify({roomId: roomId, writer: username}));
                }
            });

            $("#send-msg").on("keydown", function (event) {
                if (event.keyCode === 13) {
                    event.preventDefault();
                    document.getElementById("send-button").click();
                }
            });

            $("#send-button").on("click", function (event) {
                var msg = document.getElementById("send-msg");
                var csrfToken = $("meta[name='_csrf']").attr("content");
                var csrfHeader = $("meta[name='_csrf_header']").attr("content");
                var headers = {};
                headers[csrfHeader] = csrfToken;

                stomp.send('/pub/chat/message', {}, JSON.stringify({
                    roomId: roomId,
                    message: msg.value,
                    writer: username
                }));
                msg.value = '';
            });
        });
    </script>
</main>

</body>

</html>
